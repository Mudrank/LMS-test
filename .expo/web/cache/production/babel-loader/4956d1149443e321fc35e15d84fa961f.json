{"ast":null,"code":"import _defineProperty from\"@babel/runtime/helpers/defineProperty\";import _slicedToArray from\"@babel/runtime/helpers/slicedToArray\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}import _regeneratorRuntime from\"@babel/runtime/regenerator\";import{Platform}from'@unimodules/core';export var userMediaRequested=false;export var mountedInstances=[];function requestLegacyUserMediaAsync(props){var optionalSource,constraintToSourceId,sources,audioSource,videoSource,audioSourceId,videoSourceId;return _regeneratorRuntime.async(function requestLegacyUserMediaAsync$(_context){while(1){switch(_context.prev=_context.next){case 0:optionalSource=function optionalSource(id){return{optional:[{sourceId:id}]};};constraintToSourceId=function constraintToSourceId(constraint){var deviceId=constraint.deviceId;if(typeof deviceId==='string'){return deviceId;}if(Array.isArray(deviceId)&&deviceId.length>0){return deviceId[0];}if(typeof deviceId==='object'&&deviceId.ideal){return deviceId.ideal;}return null;};_context.next=4;return _regeneratorRuntime.awrap(new Promise(function(resolve){return MediaStreamTrack.getSources(function(sources){return resolve(sources);});}));case 4:sources=_context.sent;audioSource=null;videoSource=null;sources.forEach(function(source){if(source.kind==='audio'){audioSource=source.id;}else if(source.kind==='video'){videoSource=source.id;}});audioSourceId=constraintToSourceId(props.audioConstraints);if(audioSourceId){audioSource=audioSourceId;}videoSourceId=constraintToSourceId(props.videoConstraints);if(videoSourceId){videoSource=videoSourceId;}return _context.abrupt(\"return\",[optionalSource(audioSource),optionalSource(videoSource)]);case 13:case\"end\":return _context.stop();}}},null,null,null,Promise);}function sourceSelectedAsync(isMuted,audioConstraints,videoConstraints){var constraints;return _regeneratorRuntime.async(function sourceSelectedAsync$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:constraints={video:typeof videoConstraints!=='undefined'?videoConstraints:true};if(!isMuted){constraints.audio=typeof audioConstraints!=='undefined'?audioConstraints:true;}_context2.next=4;return _regeneratorRuntime.awrap(getAnyUserMediaAsync(constraints));case 4:return _context2.abrupt(\"return\",_context2.sent);case 5:case\"end\":return _context2.stop();}}},null,null,null,Promise);}export function requestUserMediaAsync(props){var isMuted,_await$requestLegacyU,_await$requestLegacyU2,audio,video,_args3=arguments;return _regeneratorRuntime.async(function requestUserMediaAsync$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:isMuted=_args3.length>1&&_args3[1]!==undefined?_args3[1]:true;if(!canGetUserMedia()){_context3.next=5;break;}_context3.next=4;return _regeneratorRuntime.awrap(sourceSelectedAsync(isMuted,props.audio,props.video));case 4:return _context3.abrupt(\"return\",_context3.sent);case 5:_context3.next=7;return _regeneratorRuntime.awrap(requestLegacyUserMediaAsync(props));case 7:_await$requestLegacyU=_context3.sent;_await$requestLegacyU2=_slicedToArray(_await$requestLegacyU,2);audio=_await$requestLegacyU2[0];video=_await$requestLegacyU2[1];_context3.next=13;return _regeneratorRuntime.awrap(sourceSelectedAsync(isMuted,audio,video));case 13:return _context3.abrupt(\"return\",_context3.sent);case 14:case\"end\":return _context3.stop();}}},null,null,null,Promise);}export function getAnyUserMediaAsync(constraints){var ignoreConstraints,_args4=arguments;return _regeneratorRuntime.async(function getAnyUserMediaAsync$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:ignoreConstraints=_args4.length>1&&_args4[1]!==undefined?_args4[1]:false;_context4.prev=1;_context4.next=4;return _regeneratorRuntime.awrap(getUserMediaAsync(_objectSpread(_objectSpread({},constraints),{},{video:ignoreConstraints||constraints.video})));case 4:return _context4.abrupt(\"return\",_context4.sent);case 7:_context4.prev=7;_context4.t0=_context4[\"catch\"](1);if(!(!ignoreConstraints&&_context4.t0.name==='ConstraintNotSatisfiedError')){_context4.next=13;break;}_context4.next=12;return _regeneratorRuntime.awrap(getAnyUserMediaAsync(constraints,true));case 12:return _context4.abrupt(\"return\",_context4.sent);case 13:throw _context4.t0;case 14:case\"end\":return _context4.stop();}}},null,null,[[1,7]],Promise);}export function getUserMediaAsync(constraints){var _getUserMedia;return _regeneratorRuntime.async(function getUserMediaAsync$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:if(!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)){_context5.next=2;break;}return _context5.abrupt(\"return\",navigator.mediaDevices.getUserMedia(constraints));case 2:_getUserMedia=navigator['mozGetUserMedia']||navigator['webkitGetUserMedia']||navigator['msGetUserMedia'];return _context5.abrupt(\"return\",new Promise(function(resolve,reject){return _getUserMedia.call(navigator,constraints,resolve,reject);}));case 4:case\"end\":return _context5.stop();}}},null,null,null,Promise);}export function canGetUserMedia(){return Platform.isDOMAvailable&&!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||navigator['mozGetUserMedia']||navigator['webkitGetUserMedia']||navigator['msGetUserMedia']);}export function isFrontCameraAvailableAsync(devices){return _regeneratorRuntime.async(function isFrontCameraAvailableAsync$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:_context6.next=2;return _regeneratorRuntime.awrap(supportsCameraType(['front','user','facetime'],'user',devices));case 2:return _context6.abrupt(\"return\",_context6.sent);case 3:case\"end\":return _context6.stop();}}},null,null,null,Promise);}export function isBackCameraAvailableAsync(devices){return _regeneratorRuntime.async(function isBackCameraAvailableAsync$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:_context7.next=2;return _regeneratorRuntime.awrap(supportsCameraType(['back','rear'],'environment',devices));case 2:return _context7.abrupt(\"return\",_context7.sent);case 3:case\"end\":return _context7.stop();}}},null,null,null,Promise);}function supportsCameraType(labels,type,devices){var cameras,_cameras$filter,_cameras$filter2,hasCamera,_cameras$filter3,_cameras$filter4,isCapable;return _regeneratorRuntime.async(function supportsCameraType$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:if(devices){_context8.next=6;break;}if(navigator.mediaDevices.enumerateDevices){_context8.next=3;break;}return _context8.abrupt(\"return\",null);case 3:_context8.next=5;return _regeneratorRuntime.awrap(navigator.mediaDevices.enumerateDevices());case 5:devices=_context8.sent;case 6:cameras=devices.filter(function(t){return t.kind==='videoinput';});_cameras$filter=cameras.filter(function(camera){return labels.some(function(label){return camera.label.toLowerCase().includes(label);});}),_cameras$filter2=_slicedToArray(_cameras$filter,1),hasCamera=_cameras$filter2[0];_cameras$filter3=cameras.filter(function(camera){if(!('getCapabilities'in camera)){return null;}var capabilities=camera.getCapabilities();if(!capabilities.facingMode){return null;}return capabilities.facingMode.find(function(_){return type;});}),_cameras$filter4=_slicedToArray(_cameras$filter3,1),isCapable=_cameras$filter4[0];return _context8.abrupt(\"return\",(isCapable==null?void 0:isCapable.deviceId)||(hasCamera==null?void 0:hasCamera.deviceId)||null);case 10:case\"end\":return _context8.stop();}}},null,null,null,Promise);}","map":{"version":3,"sources":["../src/WebUserMediaManager.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-env browser */\n/**\n * A web-only module for ponyfilling the UserMedia API.\n */\nimport { Platform } from '@unimodules/core';\n\nexport const userMediaRequested: boolean = false;\n\nexport const mountedInstances: any[] = [];\n\nasync function requestLegacyUserMediaAsync(props): Promise<any[]> {\n  const optionalSource = id => ({ optional: [{ sourceId: id }] });\n\n  const constraintToSourceId = constraint => {\n    const { deviceId } = constraint;\n\n    if (typeof deviceId === 'string') {\n      return deviceId;\n    }\n\n    if (Array.isArray(deviceId) && deviceId.length > 0) {\n      return deviceId[0];\n    }\n\n    if (typeof deviceId === 'object' && deviceId.ideal) {\n      return deviceId.ideal;\n    }\n\n    return null;\n  };\n\n  const sources: any[] = await new Promise(resolve =>\n    // @ts-ignore: https://caniuse.com/#search=getSources Chrome for Android (78) & Samsung Internet (10.1) use this\n    MediaStreamTrack.getSources(sources => resolve(sources))\n  );\n\n  let audioSource = null;\n  let videoSource = null;\n\n  sources.forEach(source => {\n    if (source.kind === 'audio') {\n      audioSource = source.id;\n    } else if (source.kind === 'video') {\n      videoSource = source.id;\n    }\n  });\n\n  const audioSourceId = constraintToSourceId(props.audioConstraints);\n  if (audioSourceId) {\n    audioSource = audioSourceId;\n  }\n\n  const videoSourceId = constraintToSourceId(props.videoConstraints);\n  if (videoSourceId) {\n    videoSource = videoSourceId;\n  }\n\n  return [optionalSource(audioSource), optionalSource(videoSource)];\n}\n\nasync function sourceSelectedAsync(\n  isMuted: boolean,\n  audioConstraints?: MediaTrackConstraints | boolean,\n  videoConstraints?: MediaTrackConstraints | boolean\n): Promise<MediaStream> {\n  const constraints: MediaStreamConstraints = {\n    video: typeof videoConstraints !== 'undefined' ? videoConstraints : true,\n  };\n\n  if (!isMuted) {\n    constraints.audio = typeof audioConstraints !== 'undefined' ? audioConstraints : true;\n  }\n\n  return await getAnyUserMediaAsync(constraints);\n}\n\nexport async function requestUserMediaAsync(\n  props: { audio?: any; video?: any },\n  isMuted: boolean = true\n): Promise<MediaStream> {\n  if (canGetUserMedia()) {\n    return await sourceSelectedAsync(isMuted, props.audio, props.video);\n  }\n  const [audio, video] = await requestLegacyUserMediaAsync(props);\n  return await sourceSelectedAsync(isMuted, audio, video);\n}\n\nexport async function getAnyUserMediaAsync(\n  constraints: MediaStreamConstraints,\n  ignoreConstraints: boolean = false\n): Promise<MediaStream> {\n  try {\n    return await getUserMediaAsync({\n      ...constraints,\n      video: ignoreConstraints || constraints.video,\n    });\n  } catch (error) {\n    if (!ignoreConstraints && error.name === 'ConstraintNotSatisfiedError') {\n      return await getAnyUserMediaAsync(constraints, true);\n    }\n    throw error;\n  }\n}\n\nexport async function getUserMediaAsync(constraints: MediaStreamConstraints): Promise<MediaStream> {\n  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {\n    return navigator.mediaDevices.getUserMedia(constraints);\n  }\n\n  const _getUserMedia =\n    navigator['mozGetUserMedia'] || navigator['webkitGetUserMedia'] || navigator['msGetUserMedia'];\n  return new Promise((resolve, reject) =>\n    _getUserMedia.call(navigator, constraints, resolve, reject)\n  );\n}\n\nexport function canGetUserMedia(): boolean {\n  return (\n    // SSR\n    Platform.isDOMAvailable &&\n    // Has any form of media API\n    !!(\n      (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) ||\n      navigator['mozGetUserMedia'] ||\n      navigator['webkitGetUserMedia'] ||\n      navigator['msGetUserMedia']\n    )\n  );\n}\n\nexport async function isFrontCameraAvailableAsync(\n  devices?: MediaDeviceInfo[]\n): Promise<null | string> {\n  return await supportsCameraType(['front', 'user', 'facetime'], 'user', devices);\n}\n\nexport async function isBackCameraAvailableAsync(\n  devices?: MediaDeviceInfo[]\n): Promise<null | string> {\n  return await supportsCameraType(['back', 'rear'], 'environment', devices);\n}\n\nasync function supportsCameraType(\n  labels: string[],\n  type: string,\n  devices?: MediaDeviceInfo[]\n): Promise<null | string> {\n  if (!devices) {\n    if (!navigator.mediaDevices.enumerateDevices) {\n      return null;\n    }\n    devices = await navigator.mediaDevices.enumerateDevices();\n  }\n  const cameras = devices.filter(t => t.kind === 'videoinput');\n  const [hasCamera] = cameras.filter(camera =>\n    labels.some(label => camera.label.toLowerCase().includes(label))\n  );\n  const [isCapable] = cameras.filter(camera => {\n    if (!('getCapabilities' in camera)) {\n      return null;\n    }\n\n    const capabilities = (camera as any).getCapabilities();\n    if (!capabilities.facingMode) {\n      return null;\n    }\n\n    return capabilities.facingMode.find((_: string) => type);\n  });\n\n  return isCapable?.deviceId || hasCamera?.deviceId || null;\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}