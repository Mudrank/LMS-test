{"ast":null,"code":"import _defineProperty from\"@babel/runtime/helpers/defineProperty\";import _slicedToArray from\"@babel/runtime/helpers/slicedToArray\";function _createForOfIteratorHelperLoose(o,allowArrayLike){var it=typeof Symbol!==\"undefined\"&&o[Symbol.iterator]||o[\"@@iterator\"];if(it)return(it=it.call(o)).next.bind(it);if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length===\"number\"){if(it)o=it;var i=0;return function(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]};};}throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\");}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o===\"string\")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n===\"Object\"&&o.constructor)n=o.constructor.name;if(n===\"Map\"||n===\"Set\")return Array.from(o);if(n===\"Arguments\"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen);}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i];}return arr2;}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}import _regeneratorRuntime from\"@babel/runtime/regenerator\";import*as React from'react';import*as Utils from\"./WebCameraUtils\";import{FacingModeToCameraType}from\"./WebConstants\";var VALID_SETTINGS_KEYS=['autoFocus','flashMode','exposureCompensation','colorTemperature','iso','brightness','contrast','saturation','sharpness','focusDistance','whiteBalance','zoom'];function useLoadedVideo(video,onLoaded){React.useEffect(function(){if(video){video.addEventListener('loadedmetadata',function(){requestAnimationFrame(function(){onLoaded();});});}},[video]);}export function useWebCameraStream(video,preferredType,settings,_ref){var onCameraReady=_ref.onCameraReady,onMountError=_ref.onMountError;var isStartingCamera=React.useRef(false);var activeStreams=React.useRef([]);var capabilities=React.useRef({autoFocus:'continuous',flashMode:'off',whiteBalance:'continuous',zoom:1});var _React$useState=React.useState(null),_React$useState2=_slicedToArray(_React$useState,2),stream=_React$useState2[0],setStream=_React$useState2[1];var mediaTrackSettings=React.useMemo(function(){return stream?stream.getTracks()[0].getSettings():null;},[stream]);var type=React.useMemo(function(){if(!mediaTrackSettings){return null;}var _mediaTrackSettings$f=mediaTrackSettings.facingMode,facingMode=_mediaTrackSettings$f===void 0?'user':_mediaTrackSettings$f;return FacingModeToCameraType[facingMode];},[mediaTrackSettings]);var getStreamDeviceAsync=React.useCallback(function _callee(){return _regeneratorRuntime.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;_context.next=3;return _regeneratorRuntime.awrap(Utils.getPreferredStreamDevice(preferredType));case 3:return _context.abrupt(\"return\",_context.sent);case 6:_context.prev=6;_context.t0=_context[\"catch\"](0);if(__DEV__){console.warn(\"Error requesting UserMedia for type \\\"\"+preferredType+\"\\\":\",_context.t0);}if(onMountError){onMountError({nativeEvent:_context.t0});}return _context.abrupt(\"return\",null);case 11:case\"end\":return _context.stop();}}},null,null,[[0,6]],Promise);},[preferredType,onMountError]);var resumeAsync=React.useCallback(function _callee2(){var nextStream;return _regeneratorRuntime.async(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return _regeneratorRuntime.awrap(getStreamDeviceAsync());case 2:nextStream=_context2.sent;if(!Utils.compareStreams(nextStream,stream)){_context2.next=5;break;}return _context2.abrupt(\"return\",false);case 5:if(!activeStreams.current.some(function(value){return value.id===(nextStream==null?void 0:nextStream.id);})){activeStreams.current.push(nextStream);}setStream(nextStream);if(onCameraReady){onCameraReady();}return _context2.abrupt(\"return\",false);case 9:case\"end\":return _context2.stop();}}},null,null,null,Promise);},[getStreamDeviceAsync,setStream,onCameraReady,stream,activeStreams.current]);React.useEffect(function(){if(isStartingCamera.current){return;}isStartingCamera.current=true;resumeAsync().then(function(isStarting){isStartingCamera.current=isStarting;}).catch(function(){isStartingCamera.current=false;});},[preferredType]);React.useEffect(function(){var changes={};for(var _i=0,_Object$keys=Object.keys(settings);_i<_Object$keys.length;_i++){var key=_Object$keys[_i];if(!VALID_SETTINGS_KEYS.includes(key)){continue;}var nextValue=settings[key];if(nextValue!==capabilities.current[key]){changes[key]=nextValue;}}var hasChanges=!!Object.keys(changes).length;var nextWebCameraSettings=_objectSpread(_objectSpread({},capabilities.current),changes);if(hasChanges){Utils.syncTrackCapabilities(preferredType,stream,changes);}capabilities.current=nextWebCameraSettings;},[settings.autoFocus,settings.flashMode,settings.exposureCompensation,settings.colorTemperature,settings.iso,settings.brightness,settings.contrast,settings.saturation,settings.sharpness,settings.focusDistance,settings.whiteBalance,settings.zoom]);React.useEffect(function(){if(!video.current){return;}Utils.setVideoSource(video.current,stream);},[video.current,stream]);React.useEffect(function(){return function(){for(var _iterator=_createForOfIteratorHelperLoose(activeStreams.current),_step;!(_step=_iterator()).done;){var _stream=_step.value;Utils.stopMediaStream(_stream);}if(video.current){Utils.setVideoSource(video.current,stream);}};},[]);useLoadedVideo(video.current,function(){Utils.syncTrackCapabilities(preferredType,stream,capabilities.current);});return{type:type,mediaTrackSettings:mediaTrackSettings};}","map":{"version":3,"sources":["../src/useWebCameraStream.ts"],"names":[],"mappings":"ugEACA,MAAO,GAAK,CAAA,KAAZ,KAAuB,OAAvB,CAQA,MAAO,GAAK,CAAA,KAAZ,wBACA,OAAS,sBAAT,sBAEA,GAAM,CAAA,mBAAmB,CAAG,CAC1B,WAD0B,CAE1B,WAF0B,CAG1B,sBAH0B,CAI1B,kBAJ0B,CAK1B,KAL0B,CAM1B,YAN0B,CAO1B,UAP0B,CAQ1B,YAR0B,CAS1B,WAT0B,CAU1B,eAV0B,CAW1B,cAX0B,CAY1B,MAZ0B,CAA5B,CAeA,QAAS,CAAA,cAAT,CAAwB,KAAxB,CAAwD,QAAxD,CAA4E,CAC1E,KAAK,CAAC,SAAN,CAAgB,UAAK,CACnB,GAAI,KAAJ,CAAW,CACT,KAAK,CAAC,gBAAN,CAAuB,gBAAvB,CAAyC,UAAK,CAI5C,qBAAqB,CAAC,UAAK,CACzB,QAAQ,GACT,CAFoB,CAArB,CAGD,CAPD,EAQD,CACF,CAXD,CAWG,CAAC,KAAD,CAXH,EAYD,CAED,MAAM,SAAU,CAAA,kBAAV,CACJ,KADI,CAEJ,aAFI,CAGJ,QAHI,MAOyE,IAF3E,CAAA,aAE2E,MAF3E,aAE2E,CAD3E,YAC2E,MAD3E,YAC2E,CAK7E,GAAM,CAAA,gBAAgB,CAAG,KAAK,CAAC,MAAN,CAA6B,KAA7B,CAAzB,CACA,GAAM,CAAA,aAAa,CAAG,KAAK,CAAC,MAAN,CAA4B,EAA5B,CAAtB,CACA,GAAM,CAAA,YAAY,CAAG,KAAK,CAAC,MAAN,CAAgC,CACnD,SAAS,CAAE,YADwC,CAEnD,SAAS,CAAE,KAFwC,CAGnD,YAAY,CAAE,YAHqC,CAInD,IAAI,CAAE,CAJ6C,CAAhC,CAArB,CAP6E,oBAajD,KAAK,CAAC,QAAN,CAAmC,IAAnC,CAbiD,oDAatE,MAbsE,qBAa9D,SAb8D,qBAe7E,GAAM,CAAA,kBAAkB,CAAG,KAAK,CAAC,OAAN,CAAc,UAAK,CAC5C,MAAO,CAAA,MAAM,CAAG,MAAM,CAAC,SAAP,GAAmB,CAAnB,EAAsB,WAAtB,EAAH,CAAyC,IAAtD,CACD,CAF0B,CAExB,CAAC,MAAD,CAFwB,CAA3B,CAKA,GAAM,CAAA,IAAI,CAAG,KAAK,CAAC,OAAN,CAAc,UAAK,CAC9B,GAAI,CAAC,kBAAL,CAAyB,CACvB,MAAO,KAAP,CACD,CAH6B,0BAKE,kBALF,CAKtB,UALsB,CAKtB,UALsB,gCAKT,MALS,uBAM9B,MAAO,CAAA,sBAAsB,CAAC,UAAD,CAA7B,CACD,CAPY,CAOV,CAAC,kBAAD,CAPU,CAAb,CASA,GAAM,CAAA,oBAAoB,CAAG,KAAK,CAAC,WAAN,CAAkB,qMAE9B,KAAK,CAAC,wBAAN,CAA+B,aAA/B,CAF8B,gHAI3C,GAAI,OAAJ,CAAa,CACX,OAAO,CAAC,IAAR,0CAAqD,aAArD,oBACD,CACD,GAAI,YAAJ,CAAkB,CAChB,YAAY,CAAC,CAAE,WAAW,YAAb,CAAD,CAAZ,CACD,CAT0C,gCAUpC,IAVoC,2EAAlB,CAY1B,CAAC,aAAD,CAAgB,YAAhB,CAZ0B,CAA7B,CAcA,GAAM,CAAA,WAAW,CAAG,KAAK,CAAC,WAAN,CAAkB,0MACX,oBAAoB,EADT,SAC9B,UAD8B,oBAEhC,KAAK,CAAC,cAAN,CAAqB,UAArB,CAAiC,MAAjC,CAFgC,2DAM3B,KAN2B,SAWpC,GAAI,CAAC,aAAa,CAAC,OAAd,CAAsB,IAAtB,CAA2B,SAAA,KAAK,QAAI,CAAA,KAAK,CAAC,EAAN,IAAa,UAAb,cAAa,UAAU,CAAE,EAAzB,CAAJ,EAAhC,CAAL,CAAuE,CACrE,aAAa,CAAC,OAAd,CAAsB,IAAtB,CAA2B,UAA3B,EACD,CAGD,SAAS,CAAC,UAAD,CAAT,CACA,GAAI,aAAJ,CAAmB,CACjB,aAAa,GACd,CAnBmC,iCAoB7B,KApB6B,wEAAlB,CAqBjB,CAAC,oBAAD,CAAuB,SAAvB,CAAkC,aAAlC,CAAiD,MAAjD,CAAyD,aAAa,CAAC,OAAvE,CArBiB,CAApB,CAuBA,KAAK,CAAC,SAAN,CAAgB,UAAK,CAEnB,GAAI,gBAAgB,CAAC,OAArB,CAA8B,CAC5B,OACD,CACD,gBAAgB,CAAC,OAAjB,CAA2B,IAA3B,CAEA,WAAW,GACR,IADH,CACQ,SAAA,UAAU,CAAG,CACjB,gBAAgB,CAAC,OAAjB,CAA2B,UAA3B,CACD,CAHH,EAIG,KAJH,CAIS,UAAK,CAEV,gBAAgB,CAAC,OAAjB,CAA2B,KAA3B,CACD,CAPH,EAQD,CAfD,CAeG,CAAC,aAAD,CAfH,EAkBA,KAAK,CAAC,SAAN,CAAgB,UAAK,CACnB,GAAM,CAAA,OAAO,CAAsB,EAAnC,CAEA,0BAAkB,MAAM,CAAC,IAAP,CAAY,QAAZ,CAAlB,6BAAyC,CAApC,GAAM,CAAA,GAAG,iBAAT,CACH,GAAI,CAAC,mBAAmB,CAAC,QAApB,CAA6B,GAA7B,CAAL,CAAwC,CACtC,SACD,CACD,GAAM,CAAA,SAAS,CAAG,QAAQ,CAAC,GAAD,CAA1B,CACA,GAAI,SAAS,GAAK,YAAY,CAAC,OAAb,CAAqB,GAArB,CAAlB,CAA6C,CAC3C,OAAO,CAAC,GAAD,CAAP,CAAe,SAAf,CACD,CACF,CAGD,GAAM,CAAA,UAAU,CAAG,CAAC,CAAC,MAAM,CAAC,IAAP,CAAY,OAAZ,EAAqB,MAA1C,CAEA,GAAM,CAAA,qBAAqB,gCAAQ,YAAY,CAAC,OAArB,EAAiC,OAAjC,CAA3B,CACA,GAAI,UAAJ,CAAgB,CACd,KAAK,CAAC,qBAAN,CAA4B,aAA5B,CAA2C,MAA3C,CAAmD,OAAnD,EACD,CAED,YAAY,CAAC,OAAb,CAAuB,qBAAvB,CACD,CAtBD,CAsBG,CACD,QAAQ,CAAC,SADR,CAED,QAAQ,CAAC,SAFR,CAGD,QAAQ,CAAC,oBAHR,CAID,QAAQ,CAAC,gBAJR,CAKD,QAAQ,CAAC,GALR,CAMD,QAAQ,CAAC,UANR,CAOD,QAAQ,CAAC,QAPR,CAQD,QAAQ,CAAC,UARR,CASD,QAAQ,CAAC,SATR,CAUD,QAAQ,CAAC,aAVR,CAWD,QAAQ,CAAC,YAXR,CAYD,QAAQ,CAAC,IAZR,CAtBH,EAqCA,KAAK,CAAC,SAAN,CAAgB,UAAK,CAEnB,GAAI,CAAC,KAAK,CAAC,OAAX,CAAoB,CAClB,OACD,CACD,KAAK,CAAC,cAAN,CAAqB,KAAK,CAAC,OAA3B,CAAoC,MAApC,EACD,CAND,CAMG,CAAC,KAAK,CAAC,OAAP,CAAgB,MAAhB,CANH,EAQA,KAAK,CAAC,SAAN,CAAgB,UAAK,CACnB,MAAO,WAAK,CAEV,kDAAqB,aAAa,CAAC,OAAnC,mCAA4C,IAAjC,CAAA,OAAiC,aAE1C,KAAK,CAAC,eAAN,CAAsB,OAAtB,EACD,CACD,GAAI,KAAK,CAAC,OAAV,CAAmB,CAEjB,KAAK,CAAC,cAAN,CAAqB,KAAK,CAAC,OAA3B,CAAoC,MAApC,EACD,CACF,CAVD,CAWD,CAZD,CAYG,EAZH,EAeA,cAAc,CAAC,KAAK,CAAC,OAAP,CAAgB,UAAK,CACjC,KAAK,CAAC,qBAAN,CAA4B,aAA5B,CAA2C,MAA3C,CAAmD,YAAY,CAAC,OAAhE,EACD,CAFa,CAAd,CAIA,MAAO,CACL,IAAI,CAAJ,IADK,CAEL,kBAAkB,CAAlB,kBAFK,CAAP,CAID","sourcesContent":["/* eslint-env browser */\nimport * as React from 'react';\n\nimport {\n  CameraReadyListener,\n  CameraType,\n  MountErrorListener,\n  WebCameraSettings,\n} from './Camera.types';\nimport * as Utils from './WebCameraUtils';\nimport { FacingModeToCameraType } from './WebConstants';\n\nconst VALID_SETTINGS_KEYS = [\n  'autoFocus',\n  'flashMode',\n  'exposureCompensation',\n  'colorTemperature',\n  'iso',\n  'brightness',\n  'contrast',\n  'saturation',\n  'sharpness',\n  'focusDistance',\n  'whiteBalance',\n  'zoom',\n];\n\nfunction useLoadedVideo(video: HTMLVideoElement | null, onLoaded: () => void) {\n  React.useEffect(() => {\n    if (video) {\n      video.addEventListener('loadedmetadata', () => {\n        // without this async block the constraints aren't properly applied to the camera,\n        // this means that if you were to turn on the torch and swap to the front camera,\n        // then swap back to the rear camera the torch setting wouldn't be applied.\n        requestAnimationFrame(() => {\n          onLoaded();\n        });\n      });\n    }\n  }, [video]);\n}\n\nexport function useWebCameraStream(\n  video: React.MutableRefObject<HTMLVideoElement | null>,\n  preferredType: CameraType,\n  settings: Record<string, any>,\n  {\n    onCameraReady,\n    onMountError,\n  }: { onCameraReady?: CameraReadyListener; onMountError?: MountErrorListener }\n): {\n  type: CameraType | null;\n  mediaTrackSettings: MediaTrackSettings | null;\n} {\n  const isStartingCamera = React.useRef<boolean | null>(false);\n  const activeStreams = React.useRef<MediaStream[]>([]);\n  const capabilities = React.useRef<WebCameraSettings>({\n    autoFocus: 'continuous',\n    flashMode: 'off',\n    whiteBalance: 'continuous',\n    zoom: 1,\n  });\n  const [stream, setStream] = React.useState<MediaStream | null>(null);\n\n  const mediaTrackSettings = React.useMemo(() => {\n    return stream ? stream.getTracks()[0].getSettings() : null;\n  }, [stream]);\n\n  // The actual camera type - this can be different from the incoming camera type.\n  const type = React.useMemo(() => {\n    if (!mediaTrackSettings) {\n      return null;\n    }\n    // On desktop no value will be returned, in this case we should assume the cameraType is 'front'\n    const { facingMode = 'user' } = mediaTrackSettings;\n    return FacingModeToCameraType[facingMode];\n  }, [mediaTrackSettings]);\n\n  const getStreamDeviceAsync = React.useCallback(async (): Promise<MediaStream | null> => {\n    try {\n      return await Utils.getPreferredStreamDevice(preferredType);\n    } catch (nativeEvent) {\n      if (__DEV__) {\n        console.warn(`Error requesting UserMedia for type \"${preferredType}\":`, nativeEvent);\n      }\n      if (onMountError) {\n        onMountError({ nativeEvent });\n      }\n      return null;\n    }\n  }, [preferredType, onMountError]);\n\n  const resumeAsync = React.useCallback(async (): Promise<boolean> => {\n    const nextStream = await getStreamDeviceAsync();\n    if (Utils.compareStreams(nextStream, stream)) {\n      // Do nothing if the streams are the same.\n      // This happens when the device only supports one camera (i.e. desktop) and the mode was toggled between front/back while already active.\n      // Without this check there is a screen flash while the video switches.\n      return false;\n    }\n\n    // Save a history of all active streams (usually 2+) so we can close them later.\n    // Keeping them open makes swapping camera types much faster.\n    if (!activeStreams.current.some(value => value.id === nextStream?.id)) {\n      activeStreams.current.push(nextStream!);\n    }\n\n    // Set the new stream -> update the video, settings, and actual camera type.\n    setStream(nextStream);\n    if (onCameraReady) {\n      onCameraReady();\n    }\n    return false;\n  }, [getStreamDeviceAsync, setStream, onCameraReady, stream, activeStreams.current]);\n\n  React.useEffect(() => {\n    // Restart the camera and guard concurrent actions.\n    if (isStartingCamera.current) {\n      return;\n    }\n    isStartingCamera.current = true;\n\n    resumeAsync()\n      .then(isStarting => {\n        isStartingCamera.current = isStarting;\n      })\n      .catch(() => {\n        // ensure the camera can be started again.\n        isStartingCamera.current = false;\n      });\n  }, [preferredType]);\n\n  // Update the native camera with any custom capabilities.\n  React.useEffect(() => {\n    const changes: WebCameraSettings = {};\n\n    for (const key of Object.keys(settings)) {\n      if (!VALID_SETTINGS_KEYS.includes(key)) {\n        continue;\n      }\n      const nextValue = settings[key];\n      if (nextValue !== capabilities.current[key]) {\n        changes[key] = nextValue;\n      }\n    }\n\n    // Only update the native camera if changes were found\n    const hasChanges = !!Object.keys(changes).length;\n\n    const nextWebCameraSettings = { ...capabilities.current, ...changes };\n    if (hasChanges) {\n      Utils.syncTrackCapabilities(preferredType, stream, changes);\n    }\n\n    capabilities.current = nextWebCameraSettings;\n  }, [\n    settings.autoFocus,\n    settings.flashMode,\n    settings.exposureCompensation,\n    settings.colorTemperature,\n    settings.iso,\n    settings.brightness,\n    settings.contrast,\n    settings.saturation,\n    settings.sharpness,\n    settings.focusDistance,\n    settings.whiteBalance,\n    settings.zoom,\n  ]);\n\n  React.useEffect(() => {\n    // set or unset the video source.\n    if (!video.current) {\n      return;\n    }\n    Utils.setVideoSource(video.current, stream);\n  }, [video.current, stream]);\n\n  React.useEffect(() => {\n    return () => {\n      // Clean up on dismount, this is important for making sure the camera light goes off when the component is removed.\n      for (const stream of activeStreams.current) {\n        // Close all open streams.\n        Utils.stopMediaStream(stream);\n      }\n      if (video.current) {\n        // Invalidate the video source.\n        Utils.setVideoSource(video.current, stream);\n      }\n    };\n  }, []);\n\n  // Update props when the video loads.\n  useLoadedVideo(video.current, () => {\n    Utils.syncTrackCapabilities(preferredType, stream, capabilities.current);\n  });\n\n  return {\n    type,\n    mediaTrackSettings,\n  };\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}